#--------------------------------------------------------------------------
#
#   Copyright (c) 2005, Paul Koning (see license.txt)
#
#   Name: Makefile.wxpterm
#
#   Description:
#       Build wxWidgets version of PLATO terminal emulation.
#
#--------------------------------------------------------------------------

include Makefile.common

PTERMVERSION ?= $(shell ./getkitver.py  ptermversion.h)

TYPE ?= static
ifeq ("$(TYPE)","static")
DEFWXDIR = /usr/local/wxstaticu
SETPATH=
else
ifeq ("$(TYPE)","debugascii")
DEFWXDIR = /usr/local/wxshared
ifneq ("$(HOST)","Darwin")
EXTRALIBS= -lXinerama
endif
else
DEFWXDIR = /usr/local/wxshareud
ifneq ("$(HOST)","Darwin")
EXTRALIBS= -lXinerama
endif
endif
endif
ifeq ("$(HOST)","Darwin")
ARCHCFLAGS ?= -arch i386 -arch ppc
CXX = /usr/bin/g++
#ARCHCFLAGS =  -arch ppc
#EXTRALIBS= -lwxpng-2.6 -lwxtiff-2.6
#DEFWXDIR = /usr/local/wxstaticu.264
DEFWXDIR = /usr/local/wxstaticu.2810
ARCHFLAGS=-arch i386
MSGFLAGS =  
SDLINCL=-FSDL
SDLLIBS=-Wl,-framework,SDL
else
SDLPATH ?= /usr/local
SDLINCL ?= `sdl-config --cflags`
PATH:=$(SDLPATH)/bin:$(PATH)
ifeq ("$(TYPE)","static")
SDLLIBS ?= `sdl-config --static-libs`
else
SDLLIBS ?= `sdl-config --libs`
endif
#SETPATH= -Wl,-rpath,$(WXDIR)/lib -Wl,-rpath,$(SDLPATH)/lib
endif

# if the wxmumble dir doesn't exist, try for plain /usr/local
ifeq ("$(wildcard $(DEFWXDIR))","")
DEFWXDIR=/usr/local
endif
WXDIR ?= $(DEFWXDIR)

PATH:=$(WXDIR)/bin:/usr/local/bin:$(PATH)

WXCONFIG ?= wx-config
CXXFLAGS = `$(WXCONFIG) --cxxflags`
WXLIBS	= `$(WXCONFIG) --libs` $(EXTRALIBS) 
WXVERSION = `$(WXCONFIG) --version` 

GCCVERSION := $(shell gcc --version | head -1 | awk '{print $$3}')
GCCVERSION := $(word 1, $(subst ., ,$(GCCVERSION)))

MSGFLAGS ?= -U

SDLCFLAGS = $(SDLINCL)

PTOBJS	= $(SOBJS) pterm_sdl.o pterm_wx.o 8080a.o

ifneq ("$(PTERMVERSION)","xxx")
LANGUAGES = $(shell cat languages)
MOFILES = $(addsuffix /pterm.mo,$(LANGUAGES))
endif

.PHONY : pterm-kit langdirs wxversion pterm-v$(PTERMVERSION).tar.bz2 info

info:
	echo wxdir: $(WXDIR)
	echo path:  $(PATH)
	echo wxversion: $(WXVERSION)
	echo gccversion: $(GCCVERSION)

pterm:	$(PTOBJS)
	export LD_RUN_PATH=$(WXDIR)/lib ; \
	$(CXX) $(ARCHCFLAGS) $(LDFLAGS) -g2 -o $@ $+ $(WXLIBS) $(SDLLIBS) $(SETPATH) $(STATICSW)
ifeq ("$(TYPE)","static")
ifeq ("$(HOST)","Darwin")
	#strip $@

else
	objcopy  -S -R.compact_rel -R.pdr -R.ident -R.comment $@
endif
endif

wxversion.h: wxversion
	echo "#define WXVERSION \"$(WXVERSION)\"" > wxversion.h.tmp
	date +"#define PTERMBUILDDATE \"%e %B %Y\"" >> wxversion.h.tmp
	if [ ! -r wxversion.h ]; then mv -f wxversion.h.tmp wxversion.h; else \
	  if cmp -s wxversion.h.tmp wxversion.h; then rm -f wxversion.h.tmp; \
	    else mv -f wxversion.h.tmp wxversion.h; fi; fi

dd60x:	$(SOBJS) dd60x.o knob.o iir.o 
	export LD_RUN_PATH=$(WXDIR)/lib ; \
	$(CXX) $(LDFLAGS) -o $@ $+ $(SDLLIBS) $(WXLIBS) $(SETPATH)

# console display test program
cc545:	cc545.o knob.o iir.o
	export LD_RUN_PATH=$(WXDIR)/lib ; \
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@ $+ $(WXLIBS) $(SETPATH)

ifeq ("$(HOST)","Linux")
# GCC 3.3.2-1 (from RedHat) miscompiles this on Linux if -O2 is used!
knob.o : knob.cpp
	$(CXX) -c $(CFLAGS) $(CXXFLAGS) -O1 $<
endif

ifeq ("$(HOST)","Darwin")

dd60x.app: dd60x
	mkdir -p dd60x.app/Contents/MacOS
	cp dd60x dd60x.app/Contents/MacOS
	touch $@

cc545.app: cc545
	mkdir -p cc545.app/Contents/MacOS
	cp cc545 cc545.app/Contents/MacOS
	touch $@

Pterm.app: pterm pterm-info.plist.in pterm.icns 
	sed -e "s/@PTERMVERSION@/${PTERMVERSION}/" pterm-info.plist.in > pterm-info.plist
	mkdir -p Pterm.app/Contents/MacOS Pterm.app/Contents/Resources/en
	mkdir -p $(addprefix Pterm.app/Contents/Resources/,$(LANGUAGES))
	cp pterm-info.plist Pterm.app/Contents/Info.plist
	/bin/echo -n "APPL????" > Pterm.app/Contents/PkgInfo
	cp pterm Pterm.app/Contents/MacOS/pterm
	cp pterm.icns Pterm.app/Contents/Resources/Pterm.icns
	if [[ "$(shell which msgfmt)" != "" ]] ; then for d in $(LANGUAGES); do cp $$d/pterm.mo `wx-config --prefix`/share/locale/$$d/LC_MESSAGES/wxstd.mo Pterm.app/Contents/Resources/$$d; done ; for d in $(LANGUAGES); do cp $$d/pterm.mo Pterm.app/Contents/Resources/$$d; done; fi
	touch $@

pterm-empty.dmg:
	hdiutil create -size 12m pterm-empty.dmg -layout NONE
	dev=`hdid -nomount pterm-empty.dmg` ; newfs_hfs -v ptermvol $$dev ; hdiutil detach $$dev

ptermkit.dmg: Pterm.app pterm-empty.dmg
	cp pterm-empty.dmg ptermkit.dmg
	dev=`hdid ptermkit.dmg | awk '{ print $$1 }'` ; cp -Rp Pterm.app /Volumes/ptermvol; hdiutil detach $$dev

pterm-$(PTERMVERSION).dmg: ptermkit.dmg
	rm -f $@
	hdiutil convert -format UDZO $< -o $@
	hdiutil internet-enable -yes $@

pterm-kit: 
	$(MAKE) pterm TYPE=static 
	$(MAKE) pterm-$(PTERMVERSION).dmg TYPE=static 

else
pterm-kit:  $(MOFILES) pterm-v$(PTERMVERSION).tar.bz2
	$(MAKE) pterm TYPE=static 

endif
pterm-v$(PTERMVERSION).tar.bz2:
	tar cjf pterm-v$(PTERMVERSION).tar.bz2 --exclude '*CVS*' --exclude '*~'  --exclude '*.po' license.txt *.h pterm_wx.cpp pterm_sdl.c charset.c dtnetsubs.c pterm_32.xpm Makefile.wxpterm Makefile.common Makefile languages pterm $(LANGUAGES)

mofiles: $(MOFILES)

pterm-src: ptermversion.h
	mkdir pterm-$(PTERMVERSION)
	cd pterm-$(PTERMVERSION); for f in $(LANGUAGES); do mkdir $$f; cd $$f; ln -s ../../$$f/pterm.po .; cd ..; done
	cd pterm-$(PTERMVERSION); for f in license.txt *.h pterm_32.xpm pterm_wx.cpp pterm_sdl.c charset.c dtnetsubs.c 8080a.cpp Makefile.wxpterm Makefile.common Makefile languages ; do ln -s ../$$f .; done
	tar chzf $(HOME)/pterm-linux-src-v$(PTERMVERSION).tar.gz pterm-$(PTERMVERSION)
	rm -rf pterm-$(PTERMVERSION)

pterm-rpm: pterm-src pterm.spec.in ptermversion.h
	sed -e "s/@PTERMVERSION@/${PTERMVERSION}/" pterm.spec.in > pterm.spec
	cp $(HOME)/pterm-linux-src-v$(PTERMVERSION).tar.gz /usr/src/redhat/SOURCES
	rpmbuild -ba pterm.spec

pterm.dep: $(PTOBJS:.o=.d)

%.o : %.cpp
	$(CXX) -c $(CFLAGS) $(CXXFLAGS) $<

pterm_sdl.o : pterm_sdl.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -c $<


%.d : %.cpp
	/bin/echo -n "$@ " > /tmp/$@
	$(CXX) $(CXXFLAGS) -MM -MG $< >> /tmp/$@
	mv -f /tmp/$@ $@

pterm_sdl.d : pterm_sdl.c
	/bin/echo -n "$@ " > /tmp/$@
	$(CC) $(INCL) $(SDLCFLAGS) -MM -MG $< >> /tmp/$@
	mv -f /tmp/$@ $@

%.mo : %.po
	if [[ "$(shell which msgfmt)" != "" ]] ; then msgfmt -o $@ $< ; fi

%.po : pterm_wx.cpp
	if [[ "$(shell which xgettext)" != "" ]] ; then xgettext  --keyword=_  -C -o pterm.pot pterm_wx.cpp ; msgmerge $(MSGFLAGS) $@ pterm.pot ; fi


ifeq ($(MAKECMDGOALS),pterm)
INCL+=$(SDLINCL)
DEPFILES+=  $(PTOBJS:.o=.d) 
endif
ifeq ($(MAKECMDGOALS),all)
INCL+=$(SDLINCL)
DEPFILES+=  $(PTOBJS:.o=.d) 
endif

#---------------------------  End Of File  --------------------------------

